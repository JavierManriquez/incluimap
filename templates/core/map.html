{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/map.css' %}">

<div class="map-page">

  <div class="page-head">
    <div>
      <div class="h1">Mapa â€” MaipÃº</div>
      <div class="subtle">Explora, filtra y reporta accesibilidad en tu comuna.</div>
    </div>
    <span class="badge">Colaborativo</span>
  </div>

  <div class="map-wrap">
    
    <aside class="card pad map-filters" role="complementary" aria-label="Filtros">
      <h3 class="map-filters-title">Filtros</h3>

      <form id="filters" class="form" onsubmit="return false">
        <label for="q">Buscar</label>
        <input class="input" id="q" placeholder="Nombre o direcciÃ³n">

        <div class="filters-tags-row">
          <label><input type="checkbox" id="tag-rampa"> Rampa</label>
          <label><input type="checkbox" id="tag-ascensor"> Ascensor</label>
          <label><input type="checkbox" id="tag-bano"> BaÃ±o adaptado</label>
          <label><input type="checkbox" id="tag-est"> Estac. PMR</label>
        </div>

        <div class="filters-actions">
          <button id="apply" type="button" class="btn btn-primary">Aplicar</button>
          <button id="clear" type="button" class="btn btn-ghost">Limpiar</button>
        </div>

        <div id="status" class="subtle"></div>

        <div id="empty" class="card pad" style="display:none;">
          No encontramos lugares con esos filtros.<br>
          {% if user.is_authenticated %}
            <a class="link" href="{% url 'report' %}">Â¿Quieres reportar un nuevo lugar?</a>
          {% else %}
            <a class="link" href="{% url 'login' %}?next={% url 'report' %}">
              Inicia sesiÃ³n para reportar un nuevo lugar
            </a>
          {% endif %}
        </div>
      </form>

      <div class="card pad filters-tip">
        <strong>Tip:</strong> puedes escribir â€œmetroâ€ o â€œmunicipalidadâ€.
      </div>
    </aside>

    <section class="card map-card" aria-label="Mapa de MaipÃº">
      <div class="map-actions">
        {% if user.is_authenticated %}
          <a class="btn btn-primary" href="{% url 'report' %}" title="Reportar un lugar">â• Reportar</a>
        {% else %}
          <a class="btn btn-primary" href="{% url 'login' %}?next={% url 'report' %}"
             title="Inicia sesiÃ³n para reportar">â• Reportar</a>
        {% endif %}
      </div>

      <div id="map"></div>
    </section>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  
  const MAIPU_BOUNDS = L.latLngBounds(
    L.latLng(-33.598, -70.875),
    L.latLng(-33.434, -70.686)
  );

  const map = L.map('map', {
    minZoom: 11
  });

  map.fitBounds(MAIPU_BOUNDS);

  const providers = [
    { url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attribution:'&copy; OpenStreetMap' },
    { url:'https://a.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', attribution:'&copy; OpenStreetMap, HOT' },
    { url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', attribution:'&copy; OpenStreetMap, &copy; Carto' }
  ];
  (function addTiles(i=0){
    if(i >= providers.length) return;
    const p = providers[i];
    const layer = L.tileLayer(p.url, { maxZoom: 19, attribution: p.attribution });
    layer.on('tileerror', () => { map.removeLayer(layer); addTiles(i+1); });
    layer.addTo(map);
  })();

  const locateBtn = L.control({position:'topleft'});
  locateBtn.onAdd = function(){
    const btn = L.DomUtil.create('button', 'leaflet-bar');
    btn.title = 'Mi ubicaciÃ³n';
    btn.style.padding = '6px 10px';
    btn.style.cursor = 'pointer';
    btn.innerHTML = 'ğŸ“';
    btn.onclick = () => {
      if (!navigator.geolocation) return alert('Tu navegador no permite geolocalizaciÃ³n.');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const ll = [pos.coords.latitude, pos.coords.longitude];
          if (MAIPU_BOUNDS.contains(ll)) {
            map.setView(ll, 15);
            L.circleMarker(ll, {radius:7}).addTo(map).bindPopup('EstÃ¡s aquÃ­').openPopup();
          } else {
            alert('Tu ubicaciÃ³n estÃ¡ fuera de MaipÃº.');
          }
        },
        () => alert('No se pudo obtener ubicaciÃ³n.')
      );
    };
    return btn;
  };
  locateBtn.addTo(map);

  const elQ = document.getElementById('q');
  const elStatus = document.getElementById('status');
  const elEmpty = document.getElementById('empty');
  const setStatus = t => elStatus.textContent = t || '';
  const showEmpty = s => elEmpty.style.display = s ? 'block' : 'none';

  let markers = [];
  function clearMarkers(){ markers.forEach(m => map.removeLayer(m)); markers = []; }

  function fitToMarkers(){
    if(!markers.length) return;
    const g = new L.featureGroup(markers);
    const b = g.getBounds().pad(0.2);
    map.fitBounds(b);
  }

  const stars = n => {
    const v = Math.round(Number(n) || 0);
    return 'â˜…'.repeat(v) + 'â˜†'.repeat(5 - v);
  };

  function tagsQuery(){
    const t = [];
    if (document.getElementById('tag-rampa').checked) t.push('rampa');
    if (document.getElementById('tag-ascensor').checked) t.push('ascensor');
    if (document.getElementById('tag-bano').checked) t.push('bano');
    if (document.getElementById('tag-est').checked) t.push('estac_pmr');
    return t.join(',');
  }

  async function loadPlaces(){
    try{
      setStatus('Cargandoâ€¦'); showEmpty(false);

      const q = encodeURIComponent((elQ.value || '').trim());
      const tags = encodeURIComponent(tagsQuery());
      const qs = ['commune=maipu'];
      if (q) qs.push(`q=${q}`);
      if (tags) qs.push(`tags=${tags}`);

      const resp = await fetch(`/api/places/?${qs.join('&')}`, {
        headers: { 'Accept': 'application/json' }
      });

      if (!resp.ok){
        setStatus(`Error ${resp.status}`);
        showEmpty(true);
        return;
      }

      const json = await resp.json();
      const results = json.results || json.places || [];

      clearMarkers();
      let added = 0;

      results.forEach(p => {
        const lat = parseFloat(p.lat), lng = parseFloat(p.lng);
        if (isNaN(lat) || isNaN(lng)) return;
        if (!MAIPU_BOUNDS.contains([lat, lng])) return;

        const avg = (p.avg_rating != null) ? Number(p.avg_rating).toFixed(1) : 'â€“';
        const count = p.reports_count || 0;

        const reportHref = `/reportar/?place=${encodeURIComponent(p.id)}`;
        const reportLink = `
          <div style="margin-top:8px">
            <a href="${reportHref}" class="btn btn-ghost" style="display:inline-flex">Reportar este lugar</a>
          </div>`;

        const marker = L.marker([lat, lng]).addTo(map).bindPopup(
          `<b>${p.name || '(sin nombre)'}</b><br>${p.address || ''}<br>
           <span class="subtle">${p.tags || ''}</span><br>
           <div style="margin-top:6px">
             <span title="Promedio">${stars(avg)}</span>
             <span class="subtle" style="margin-left:6px">(${avg} Â· ${count} reporte${count===1?'':'s'})</span>
           </div>
           ${reportLink}`
        );
        markers.push(marker);
        added++;
      });

      if (added === 0){
        showEmpty(true);
        setStatus('0 resultados');
      } else {
        showEmpty(false);
        setStatus(`${added} resultado${added===1?'':'s'}`);
        fitToMarkers();
      }
    } catch (e){
      console.error('Error cargando lugares', e);
      setStatus('Error cargando lugares');
      showEmpty(true);
    }
  }

  document.getElementById('apply').addEventListener('click', loadPlaces);
  document.getElementById('clear').addEventListener('click', () => {
    elQ.value = '';
    ['tag-rampa','tag-ascensor','tag-bano','tag-est']
      .forEach(id => document.getElementById(id).checked = false);
    loadPlaces();
  });

  elQ.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); loadPlaces(); }});

  const debounce = (fn, ms=350) => { let t; return (...a) => {
    clearTimeout(t); t = setTimeout(() => fn(...a), ms);
  }; };

  elQ.addEventListener('input', debounce(loadPlaces, 400));

  ['tag-rampa','tag-ascensor','tag-bano','tag-est']
    .forEach(id => document.getElementById(id).addEventListener('change', loadPlaces));

  window.addEventListener('resize', () => map.invalidateSize());
  document.addEventListener('scroll', () => map.invalidateSize());

  loadPlaces();
});
</script>

{% endblock %}

