{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <div>
    <div class="h1">Dashboard de Accesibilidad</div>
    <div class="subtle">
      Métricas basadas en los <strong>reportes enviados</strong>: estrellas y tags.
    </div>
  </div>
</div>

<style>

  .dash-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
  }

  .dash-table thead th {
    background: linear-gradient(135deg, rgba(0,255,255,.18), rgba(0,120,255,.20));
    text-transform: uppercase;
    letter-spacing: .03em;
    font-size: 0.8rem;
    border-bottom: 1px solid rgba(0,255,255,.35);
  }

  .dash-table th,
  .dash-table td {
    padding: 8px 10px;
    border: 1px solid rgba(255,255,255,.12);
  }

  .dash-table tbody tr:nth-child(even) {
    background: rgba(255,255,255,.02);
  }

  .dash-table tbody tr:hover {
    background: rgba(0,255,200,.10);
  }

  
  .dash-charts-row {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    margin-top: 16px;
  }

  .dash-chart-card {
    flex: 1 1 320px;
    min-width: 280px;
    border-radius: 18px;
    padding: 16px 18px;
    border: 1px solid rgba(255,255,255,.15);
    background: radial-gradient(circle at 0% 0%, rgba(0,255,200,.10), rgba(0,0,30,.85));
    box-shadow: 0 14px 35px rgba(0,0,0,.55);
  }

  .dash-chart-card h3 {
    margin-bottom: 10px;
    font-size: 0.98rem;
  }
</style>

<div class="grid-2">
  
  <div class="card pad">
    <h2>Lugares — Evaluación promedio</h2>
    <p class="subtle">Promedio de rating y número de reportes por lugar.</p>

    <table class="table dash-table">
      <thead>
        <tr>
          <th>Lugar</th>
          <th>Promedio ⭐</th>
          <th># Reportes</th>
        </tr>
      </thead>
      <tbody>
        {% for place in places_stats %}
          <tr>
            <td>{{ place.name }}</td>
            <td>
              {% if place.avg_rating %}
                {{ place.avg_rating|floatformat:1 }}
              {% else %}-{% endif %}
            </td>
            <td>{{ place.reports_count }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3">No hay lugares con reportes aún.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  
  <div class="card pad">
    <h2>Problemas por tipo (tags)</h2>
    <p class="subtle">
      Cantidad de reportes y promedio de rating para cada tag registrado.
    </p>

    <table class="table dash-table">
      <thead>
        <tr>
          <th>Tag</th>
          <th># Reportes</th>
          <th>Promedio ⭐</th>
        </tr>
      </thead>
      <tbody>
        {% for row in tags_stats %}
          <tr>
            <td>{{ row.tags }}</td>
            <td>{{ row.total_reportes }}</td>
            <td>
              {% if row.avg_rating %}
                {{ row.avg_rating|floatformat:1 }}
              {% else %}-{% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="3">No hay reportes con tags todavía.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<div class="card pad" style="margin-top: 24px;">
  <h2>Gráficos de accesibilidad por tags</h2>
  <p class="subtle">
    Visualización de la <strong>frecuencia</strong> de cada tipo de problema y su
    <strong>evaluación promedio</strong> en estrellas.
  </p>

  <div class="dash-charts-row">
    <div class="dash-chart-card">
      <h3>Cantidad de reportes por tag</h3>
      <canvas id="tagsCountChart"></canvas>
    </div>

    <div class="dash-chart-card">
      <h3>Promedio de estrellas por tag</h3>
      <canvas id="tagsRatingChart"></canvas>
    </div>
  </div>
</div>

{# Bloque JSON con los datos para los gráficos #}
<script id="chart-data" type="application/json">
{
  "labels": {{ tag_labels_json|safe }},
  "counts": {{ tag_counts_json|safe }},
  "ratings": {{ tag_avg_ratings_json|safe }}
}
</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

const chartDataEl = document.getElementById("chart-data");
let chartData = { labels: [], counts: [], ratings: [] };

if (chartDataEl) {
  try {
    chartData = JSON.parse(chartDataEl.textContent);
  } catch (err) {
    console.error("Error al parsear los datos del dashboard:", err);
  }
}

const tagLabels = chartData.labels || [];
const tagCounts = chartData.counts || [];
const tagAvgRatings = chartData.ratings || [];


const axisTextColor = "#E6F7FF";
const gridColor = "rgba(230,247,255,0.18)";
const barsCountColor = "rgba(0, 200, 255, 0.65)";
const barsCountBorder = "rgba(0, 255, 255, 0.95)";
const barsRatingColor = "rgba(0, 255, 170, 0.65)";
const barsRatingBorder = "rgba(0, 255, 170, 0.95)";


const ctxCount = document.getElementById('tagsCountChart');
if (ctxCount && tagLabels.length > 0) {
  new Chart(ctxCount, {
    type: 'bar',
    data: {
      labels: tagLabels,
      datasets: [{
        label: 'Cantidad de reportes',
        data: tagCounts,
        backgroundColor: barsCountColor,
        borderColor: barsCountBorder,
        borderWidth: 1.5,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: true }
      },
      scales: {
        x: {
          ticks: { 
            autoSkip: false, 
            maxRotation: 45, 
            minRotation: 0,
            color: axisTextColor
          },
          grid: { color: gridColor }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Número de reportes', color: axisTextColor },
          ticks: { color: axisTextColor },
          grid: { color: gridColor }
        }
      }
    }
  });
}


const ctxRating = document.getElementById('tagsRatingChart');
if (ctxRating && tagLabels.length > 0) {
  new Chart(ctxRating, {
    type: 'bar',
    data: {
      labels: tagLabels,
      datasets: [{
        label: 'Promedio de estrellas',
        data: tagAvgRatings,
        backgroundColor: barsRatingColor,
        borderColor: barsRatingBorder,
        borderWidth: 1.5,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: true }
      },
      scales: {
        x: {
          ticks: { 
            autoSkip: false, 
            maxRotation: 45, 
            minRotation: 0,
            color: axisTextColor
          },
          grid: { color: gridColor }
        },
        y: {
          beginAtZero: true,
          max: 5,
          title: { display: true, text: 'Rating promedio (1–5)', color: axisTextColor },
          ticks: { color: axisTextColor },
          grid: { color: gridColor }
        }
      }
    }
  });
}
</script>

{% endblock %}

